<?xml version="1.0" encoding="utf-8"?>

<Defs>
  <QuestScriptDef>
    <defName>OpportunitySite_BanditCamp_Giver</defName>
    <isRootSpecial>true</isRootSpecial>
    <randomlySelectable>false</randomlySelectable>
    <givenBy>
      <li>Traders</li>
      <li>Beggars</li>
      <li>Reading</li>
    </givenBy>
    <rootSelectionWeight>0.5</rootSelectionWeight>
    <rootMinPoints>350</rootMinPoints>
    <autoAccept>true</autoAccept>
    <canGiveRoyalFavor>true</canGiveRoyalFavor>
    <successHistoryEvent MayRequire="Ludeon.RimWorld.Ideology">Raided_BanditCamp</successHistoryEvent>
    <questNameRules>
      <rulesStrings>
        <li>questName->The [bandit] [camp]</li>
        <li>questName->[bandit] [camp]</li>
        <li>questName->[asker_nameDef] and the [camp]</li>
        <li>camp->Camp</li>
        <li>camp->Outpost</li>
        <li>camp->Lair</li>
        <li>camp->Encampment</li>
        <li>bandit->Bandit</li>
        <li>bandit->Raider</li>
        <li>bandit->Outlaw</li>
        <li>bandit->Desperado</li>
        <li>bandit->Fugitive</li>
        <li>bandit->Marauder</li>
        <li>bandit->Robber</li>
        <li>bandit->Brigand</li>
      </rulesStrings>
    </questNameRules>
    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->[discoveryMethod] the location of a camp controlled by [siteFaction_name]. The camp contains hostile [siteFaction_pawnsPlural], but you don't know what defenses they have.</li>
      </rulesStrings>
    </questDescriptionRules>
    <questSubjectRules>
      <rulesStrings>
        <li>subject->bandit camps</li>
        <li>subject->outlaws</li>
        <li>subject->raider sightings</li>

        <li>questMapFeature->small camp</li>
        <li>questMapFeature->bandit outpost</li>
        <li>questMapFeature->raider encampment</li>

        <li>questMapText->dangerous folk</li>
        <li>questMapText->camp loot</li>
        <li>questMapText->trespassers get skinned</li>
        <li>questMapText->traders beware - outlaws</li>
      </rulesStrings>
    </questSubjectRules>
    <root Class="QuestNode_Sequence">
      <nodes>
        <li Class="QuestNode_SubScript">
          <def>Util_RandomizePointsChallengeRating</def>
          <parms>
            <pointsFactorTwoStar>1.5</pointsFactorTwoStar>
            <pointsFactorThreeStar>2</pointsFactorThreeStar>
          </parms>
        </li>
        <li Class="QuestNode_SubScript">
          <def>Util_AdjustPointsForDistantFight</def>
        </li>

        <li Class="QuestNode_GetMap">
          <canBeSpace>true</canBeSpace>
        </li>

        <li Class="QuestNode_GetPawn">
          <storeAs>asker</storeAs>
          <mustBeFactionLeader>true</mustBeFactionLeader>
          <allowPermanentEnemyFaction>false</allowPermanentEnemyFaction>
          <hostileWeight>0.15</hostileWeight>
        </li>

        <li Class="QuestNode_Set">
          <name>siteDistRange</name>
          <value>20~60</value>
        </li>
        <li Class="QuestNode_GetSiteTile">
          <storeAs>siteTile</storeAs>
          <preferCloserTiles>true</preferCloserTiles>
          <selectLandmarkChance>0.75</selectLandmarkChance>
          <allowedLandmarks>
            <li>Oasis</li>
            <li>Lake</li>
            <li>LakeWithIsland</li>
            <li>LakeWithIslands</li>
            <li>Pond</li>
            <li>DryLake</li>
            <li>ToxicLake</li>
            <li>Wetland</li>
            <li>HotSprings</li>
            <li>Archipelago</li>
            <li>CoastalIsland</li>
            <li>Peninsula</li>
            <li>Bay</li>
            <li>Valley</li>
            <li>Cavern</li>
            <li>Chasm</li>
            <li>Cliffs</li>
            <li>Hollow</li>
            <li>TerraformingScar</li>
            <li>LavaLake</li>
            <li>Dunes</li>
            <li>AncientHeatVent</li>
          </allowedLandmarks>
        </li>

        <li Class="QuestNode_GetSitePartDefsByTagsAndFaction">
          <storeAs>sitePartDefs</storeAs>
          <storeFactionAs>siteFaction</storeFactionAs>
          <sitePartsTags>
            <li><tag>BanditCamp</tag></li>
          </sitePartsTags>
          <mustBeHostileToFactionOf>$asker</mustBeHostileToFactionOf>
        </li>

        <li Class="QuestNode_GetDefaultSitePartsParams">
          <tile>$siteTile</tile>
          <faction>$siteFaction</faction>
          <sitePartDefs>$sitePartDefs</sitePartDefs>
          <storeSitePartsParamsAs>sitePartsParams</storeSitePartsParamsAs>
        </li>

        <li Class="QuestNode_GetSiteThreatPoints">
          <storeAs>sitePoints</storeAs>
          <sitePartsParams>$sitePartsParams</sitePartsParams>
        </li>

        <li Class="QuestNode_SubScript">
          <def>Util_GenerateSite</def>
        </li>

        <li Class="QuestNode_SpawnWorldObjects">
          <worldObjects>$site</worldObjects>
        </li>

        <li Class="QuestNode_WorldObjectTimeout">
          <worldObject>$site</worldObject>
          <isQuestTimeout>true</isQuestTimeout>
          <delayTicks>$(randInt(25,35)*60000)</delayTicks>
          <inSignalDisable>site.MapGenerated</inSignalDisable>
          <destroyOnCleanup>true</destroyOnCleanup>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Letter">
                <label TKey="LetterLabelQuestExpired">Quest expired: [resolvedQuestName]</label>
                <text TKey="LetterTextQuestExpired">The bandit camp has packed up and moved on. The quest [resolvedQuestName] has expired.</text>
              </li>
              <li Class="QuestNode_End">
                <outcome>Fail</outcome>
              </li>
            </nodes>
          </node>
        </li>

        <!-- If we enter and leave, the map is destroyed. Fail the quest. -->
        <li Class="QuestNode_Signal">
          <inSignal>site.Destroyed</inSignal>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Letter">
                <label TKey="LetterLabelQuestFailed">Quest failed: [resolvedQuestName]</label>
                <text TKey="LetterTextQuestFailed">After being discovered, the bandit camp has dispersed. The quest [resolvedQuestName] has ended.</text>
              </li>
              <li Class="QuestNode_End">
                <outcome>Fail</outcome>
              </li>
            </nodes>
          </node>
        </li>

        <li Class="QuestNode_Signal">
          <inSignal>site.AllEnemiesDefeated</inSignal>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Notify_PlayerRaidedSomeone">
                <getRaidersFromMapParent>$site</getRaidersFromMapParent>
              </li>
              <li Class="QuestNode_CampLootReward" />
            </nodes>
          </node>
        </li>
        <li Class="QuestNode_End">
          <inSignal>site.AllEnemiesDefeated</inSignal>
          <outcome>Success</outcome>
        </li>
      </nodes>
    </root>
  </QuestScriptDef>
</Defs>